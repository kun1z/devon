#include <stdint.h>
#include <string.h>
//----------------------------------------------------------------------------------------------------------------------
// C577A8FA7CDDAD9FFF0CC48159E3CB7F2B216354BCF38826C5D09B7B3755FFD8608EF8020D19E3A570D8511BCC492D0B25359CC1267FA6F8EBB41318830B4CEB
// 9F9EDC7C84F7AE474629F579EC6C300A29E22DABB0894B67738717086BE8F659D331567152FFABD762FD7584BFEF06A845D0F66D1A69352E513FEF48180AF3AB
// 598AC3DC074BF8434BDB9B55AD406D5704B50EB0AE00A75BACE08346686441E52D9D3030FD79486A4062358A21815CE0A71C0B0C86FFA138CCB06610E0A9EC35
//----------------------------------------------------------------------------------------------------------------------
void blake2b_mod2(void * const out64, void const * const in64, void const * const in64_2, void const * const key128)
{
    const uint8_t sigma[12][16] =
    {
        {  0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15 },
        { 14, 10,  4,  8,  9, 15, 13,  6,  1, 12,  0,  2, 11,  7,  5,  3 },
        { 11,  8, 12,  0,  5,  2, 15, 13, 10, 14,  3,  6,  7,  1,  9,  4 },
        {  7,  9,  3,  1, 13, 12, 11, 14,  2,  6,  5, 10,  4,  0, 15,  8 },
        {  9,  0,  5,  7,  2,  4, 10, 15, 14,  1, 11, 12,  6,  8,  3, 13 },
        {  2, 12,  6, 10,  0, 11,  8,  3,  4, 13,  7,  5, 15, 14,  1,  9 },
        { 12,  5,  1, 15, 14, 13,  4, 10,  0,  7,  6,  3,  9,  2,  8, 11 },
        { 13, 11,  7, 14, 12,  1,  3,  9,  5,  0, 15,  4,  8,  6,  2, 10 },
        {  6, 15, 14,  9, 11,  3,  0,  8, 12,  2, 13,  7,  1,  4, 10,  5 },
        { 10,  2,  8,  4,  7,  6,  1,  5, 15, 11,  9, 14,  3, 12, 13 , 0 },
        {  0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15 },
        { 14, 10,  4,  8,  9, 15, 13,  6,  1, 12,  0,  2, 11,  7,  5,  3 },
    };

    uint64_t IV[16] =
    {
        0x6A09E667F3BCC908, 0xBB67AE8584CAA73B, 0x3C6EF372FE94F82B, 0xA54FF53A5F1D36F1,
        0x510E527FADE682D1, 0x9B05688C2B3E6C1F, 0x1F83D9ABFB41BD6B, 0x5BE0CD19137E2179,
        0x5E81F7441C8A32F1, 0x9CEC8DEEA95448E7, 0xAF60D7CF70066845, 0x2E951F365CB7B472,
        0xD5781ABB081899BF, 0x523D95E8E9165E4C, 0xF8891B6F125CD0DC, 0xF4FE36B218BC1F64,
    };

    uint64_t v[16], m[16];

    if (key128)
    {
        for (int i=0;i<128;i++)
        {
            unsigned char const * const k = key128;
            unsigned char * const iv = (unsigned char*)IV;
            iv[i] ^= k[i];
        }
    }

    memcpy(v, IV, 128);
    memcpy(m, in64  , 64);

    if (in64_2)
    {
        memcpy(&m[8], in64_2, 64);
    }
    else
    {
        memset(&m[8], 0, 64);
    }

    for (int i=0;i<12;i++)
    {
        #define G(r,i,a,b,c,d)              \
        do {                                \
            a = a + b + m[sigma[r][2*i+0]]; \
            d = ((d^a)>>32)|((d^a)<<32);    \
            c = c + d;                      \
            b = ((b^c)>>24)|((b^c)<<40);    \
            a = a + b + m[sigma[r][2*i+1]]; \
            d = ((d^a)>>16)|((d^a)<<48);    \
            c = c + d;                      \
            b = ((b^c)>>63)|((b^c)<<1);     \
        } while(0)

        G(i, 0, v[ 0], v[ 4], v[ 8], v[12]);
        G(i, 1, v[ 1], v[ 5], v[ 9], v[13]);
        G(i, 2, v[ 2], v[ 6], v[10], v[14]);
        G(i, 3, v[ 3], v[ 7], v[11], v[15]);
        G(i, 4, v[ 0], v[ 5], v[10], v[15]);
        G(i, 5, v[ 1], v[ 6], v[11], v[12]);
        G(i, 6, v[ 2], v[ 7], v[ 8], v[13]);
        G(i, 7, v[ 3], v[ 4], v[ 9], v[14]);
    }

    for (int i=0;i<8;i++)
    {
        unsigned char * const restrict p = out64;
        const uint64_t output = IV[i] ^ v[i] ^ v[i + 8];
        memcpy(&p[i * 8], &output, 8);
    }
}
//----------------------------------------------------------------------------------------------------------------------